<!DOCTYPE html>
<html lang="fr">
<head>
    <meta name="google-adsense-account" content="ca-pub-5904049904040571">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>djioukeli.com - Visionnage de vidéo</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Intégration de Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-storage-compat.js"></script>
    
    <style>
        :root {
            --primary-color: #3498db;
            --secondary-color: #2980b9;
            --accent-color: #e74c3c;
            --light-color: #f8f9fa;
            --dark-color: #343a40;
            --success-color: #28a745;
            --border-radius: 8px;
            --box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Roboto', sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #f4f4f9;
            overflow-x: hidden;
            position: relative;
        }
        /* Bottom Navigation Bar */
.bottom-nav {
    position: fixed;
    bottom: 0;
    left: 0;
    width: 100%;
    background-color: white;
    display: flex;
    justify-content: space-around;
    align-items: center;
    padding: 10px 0;
    box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
    z-index: 1000;
}

.nav-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    text-decoration: none;
    color: #666;
    font-size: 12px;
    transition: all 0.3s;
}

.nav-item.active, .nav-item:hover {
    color: var(--primary-color);
}

.nav-item.active .nav-icon {
    color: var(--primary-color);
    transform: scale(1.1);
}

.nav-icon {
    font-size: 20px;
    margin-bottom: 4px;
    color: #666;
    transition: all 0.3s;
}

/* Ajouter un padding au body pour éviter que le contenu ne soit caché par la navigation */
body {
    padding-bottom: 70px;
} 
        
        .container {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 15px;
        }
        
        /* Site Title Only */
        .site-title-only {
            text-align: center;
            padding: 15px 0;
            background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
            color: white;
            font-family: 'Poppins', sans-serif;
            font-weight: 700;
            font-size: 24px;
            box-shadow: var(--box-shadow);
        }
        
        /* Main Content */
        .main-content {
            display: flex;
            margin: 20px 0;
            gap: 20px;
        }
        
        .content {
            flex: 3;
        }
        
        .sidebar {
            flex: 1;
        }
        
        /* Featured Video Section */
        .featured-video {
            width: 100%;
            background-color: #000;
            margin-bottom: 30px;
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--box-shadow);
        }
        
        .featured-video-container {
            position: relative;
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
        }
        
        /* Format 9:16 pour la vidéo */
        .video-container-9-16 {
            position: relative;
            width: 100%;
            padding-top: 177.78%; /* 9:16 Aspect Ratio (9/16 * 100) */
            background-color: #000;
        }
        
        .video-container-9-16 video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .featured-video-info {
            padding: 15px;
            color: #333;
            background-color: white;
        }
        
        .featured-video-title {
            font-size: 1.5rem;
            margin-bottom: 8px;
            font-weight: 600;
        }
        
        .featured-video-stats {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
            font-size: 14px;
        }
        
        .video-views, .video-date, .video-author {
            display: flex;
            align-items: center;
            gap: 5px;
            color: #666;
        }
        
        .video-author {
            color: var(--primary-color);
            cursor: pointer;
            font-weight: 500;
        }
        
        .video-author:hover {
            text-decoration: underline;
        }
        
        .share-container {
            display: flex;
            justify-content: center;
            margin-top: 15px;
        }
        
        .share-btn {
            padding: 10px 20px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
            transition: background-color 0.3s;
        }
        
        .share-btn:hover {
            background-color: var(--secondary-color);
        }
        
        .back-btn {
            display: inline-flex;
            align-items: center;
            padding: 10px 15px;
            background-color: #6c757d;
            color: white;
            text-decoration: none;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
            transition: background-color 0.3s;
        }
        
        .back-btn:hover {
            background-color: #5a6268;
        }
        
        /* Similar Videos Section */
        .similar-videos-section {
            margin-top: 30px;
        }
        
        .section-title {
            font-family: 'Poppins', sans-serif;
            margin: 15px 0;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--primary-color);
            color: var(--dark-color);
            font-size: 1.3rem;
        }
        
        .videos-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .video-card {
            background-color: white;
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--box-shadow);
            transition: transform 0.3s ease;
            cursor: pointer;
        }
        
        .video-card:hover {
            transform: translateY(-3px);
        }
        
        .video-thumbnail {
            position: relative;
            width: 100%;
            height: 120px;
            overflow: hidden;
        }
        
        .video-thumbnail video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border: none;
        }
        
        .video-info {
            padding: 10px;
        }
        
        .video-title {
            font-weight: 600;
            margin-bottom: 5px;
            font-size: 14px;
            height: 40px;
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }
        
        .video-meta {
            font-size: 12px;
            color: #666;
            display: flex;
            justify-content: space-between;
        }
        
        /* Sidebar Ads */
        .ad-container {
            background-color: white;
            border-radius: var(--border-radius);
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: var(--box-shadow);
            text-align: center;
        }
        
        .ad-title {
            font-size: 14px;
            color: #666;
            margin-bottom: 10px;
        }
        
        /* Footer */
        footer {
            background-color: var(--dark-color);
            color: white;
            padding: 20px 0;
            margin-top: 30px;
        }
        
        .footer-content {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
        }
        
        .footer-section {
            flex: 1;
            min-width: 200px;
            margin-bottom: 15px;
        }
        
        .footer-section h4 {
            font-family: 'Poppins', sans-serif;
            margin-bottom: 10px;
            font-size: 16px;
            color: white;
        }
        
        .footer-section p, .footer-section a {
            color: #ddd;
            margin-bottom: 8px;
            display: block;
            text-decoration: none;
            font-size: 14px;
        }
        
        .footer-section a:hover {
            color: white;
        }
        
        .copyright {
            text-align: center;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #555;
            font-size: 14px;
        }
        
        /* Ad Overlay */
        .ad-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            display: none;
        }
        
        .ad-overlay-content {
            background-color: white;
            padding: 25px;
            border-radius: var(--border-radius);
            text-align: center;
            max-width: 500px;
            width: 90%;
        }
        
        .ad-overlay-content h2 {
            margin-bottom: 15px;
            color: var(--dark-color);
        }
        
        .ad-overlay-content p {
            margin-bottom: 20px;
            color: #666;
            line-height: 1.5;
        }
        
        .ad-overlay-btn {
            padding: 12px 25px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 500;
            font-size: 16px;
        }
        
        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 10000;
            overflow: auto;
        }
        
        .modal-content {
            background-color: white;
            margin: 10% auto;
            padding: 20px;
            border-radius: var(--border-radius);
            width: 90%;
            max-width: 500px;
            box-shadow: var(--box-shadow);
            position: relative;
        }
        
        .close-modal {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 24px;
            cursor: pointer;
            color: #aaa;
            background: none;
            border: none;
        }
        
        .close-modal:hover {
            color: var(--accent-color);
        }
        
        .share-options {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 20px;
        }
        
        .share-option-btn {
            padding: 12px;
            border: none;
            border-radius: var(--border-radius);
            color: white;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: opacity 0.3s;
        }
        
        .share-option-btn:hover {
            opacity: 0.9;
        }
        
        .share-option-btn:nth-child(1) {
            background-color: #1877F2; /* Facebook */
        }
        
        .share-option-btn:nth-child(2) {
            background-color: #1DA1F2; /* Twitter */
        }
        
        .share-option-btn:nth-child(3) {
            background-color: #25D366; /* WhatsApp */
        }
        
        .share-option-btn:nth-child(4) {
            background-color: #6c757d; /* Copier lien */
        }
        
        /* Loading Animation */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 150px;
        }
        
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Responsive Design */
        @media (max-width: 992px) {
            .main-content {
                flex-direction: column;
            }
            
            .sidebar {
                order: -1;
            }
        }
        
        @media (max-width: 768px) {
            .videos-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            }
            
            .footer-section {
                min-width: 100%;
            }
            
            .featured-video-title {
                font-size: 1.3rem;
            }
            
            .featured-video-stats {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }
            
            .share-options {
                grid-template-columns: 1fr;
            }
        }
        .user-credits-container {
    background-color: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 20px;
    padding: 5px 15px;
    display: flex;
    align-items: center;
    gap: 8px;
    font-weight: bold;
    color: #ffc107;
    margin-right: 15px;
}

.user-credits-container i {
    color: #ffc107;
}
    </style>
</head>
<body>
    <!-- Site Title Only -->
    <div class="site-title-only">
        djoukeli.com
        <div id="userCredits" class="user-credits-container" style="display: none;">
    <i class="fas fa-coins"></i>
    <span class="user-credits">0</span> crédits
</div>
    </div>

    <!-- Ad Overlay (hidden by default) -->
    <div id="adOverlay" class="ad-overlay">
        <div class="ad-overlay-content">
            <h2>Publicité Obligatoire</h2>
            <p>Pour continuer à regarder cette vidéo, vous devez visionner cette publicité. Cliquez sur le bouton ci-dessous pour accéder au contenu publicitaire.</p>
            <button class="ad-overlay-btn" onclick="openAdLink()">
                <i class="fas fa-external-link-alt"></i> Voir la publicité
            </button>
        </div>
    </div>

    <!-- Share Modal -->
    <div id="shareModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal('shareModal')">&times;</span>
            <h2>Partager cette vidéo</h2>
            <div class="share-options">
                <button class="share-option-btn" onclick="shareVideo(currentVideoId, 'facebook')">
                    <i class="fab fa-facebook"></i> Facebook
                </button>
                <button class="share-option-btn" onclick="shareVideo(currentVideoId, 'twitter')">
                    <i class="fab fa-twitter"></i> Twitter
                </button>
                <button class="share-option-btn" onclick="shareVideo(currentVideoId, 'whatsapp')">
                    <i class="fab fa-whatsapp"></i> WhatsApp
                </button>
                <button class="share-option-btn" onclick="copyShareLink(currentVideoId)">
                    <i class="fas fa-link"></i> Copier le lien
                </button>
            </div>
        </div>
    </div>

    <!-- Alert Modal -->
    <div id="alertModal" class="modal">
        <div class="modal-content">
            <h2 id="alertModalTitle">Alerte</h2>
            <p id="alertModalMessage">Message d'alerte</p>
            <div style="text-align: center; margin-top: 20px;">
                <button class="ad-overlay-btn" onclick="closeModal('alertModal')">OK</button>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container">
        <a href="index.html" class="back-btn">
            <i class="fas fa-arrow-left"></i> Retour à l'accueil
        </a>

        <!-- Featured Video Section -->
        <div id="featuredVideoContainer" class="featured-video">
            <div class="featured-video-container">
                <div class="video-container-9-16">
                    <video id="featuredVideoPlayer" controls></video>
                </div>
            </div>
            <div class="featured-video-info">
                <h2 id="featuredVideoTitle" class="featured-video-title">Chargement de la vidéo...</h2>
                
                <div class="featured-video-stats">
                    <div class="video-views">
                        <i class="fas fa-eye"></i> <span id="featuredVideoViews">0</span> vues
                    </div>
                    <div class="video-date">
                        <i class="far fa-calendar-alt"></i> <span id="featuredVideoDate">Date inconnue</span>
                    </div>
                    <div class="video-author" id="featuredVideoAuthor">
                        <i class="fas fa-user"></i> <span id="featuredVideoUsername">Utilisateur</span>
                    </div>
                </div>
                
                <div class="share-container">
                    <button class="share-btn" onclick="openModal('shareModal')">
                        <i class="fas fa-share-alt"></i> Partager cette vidéo
                    </button>
                </div>
            </div>
        </div>

        <div class="main-content">
            <div class="content">
                <!-- Similar Videos Section -->
                <div class="similar-videos-section">
                    <h2 class="section-title">Vidéos similaires</h2>
                    <div class="videos-grid" id="similarVideosContainer">
                        <div class="loading">
                            <div class="loading-spinner"></div>
                        </div>
                    </div>
                </div>
            </div>
            

            <!-- Sidebar with Ads -->
            <div class="sidebar">
                <!-- Banner Ad 1 -->
                <div class="ad-container">
                    <div class="ad-title">Annonce</div>
                    <script type="text/javascript">
                        atOptions = {
                            'key' : 'b60bc4acc212e29cd7bb4880768c98b6',
                            'format' : 'iframe',
                            'height' : 60,
                            'width' : 468,
                            'params' : {}
                        };
                    </script>
                    <script type="text/javascript" src="//hedwigflooredventure.com/b60bc4acc212e29cd7bb4880768c98b6/invoke.js"></script>
                </div>

                <!-- Banner Ad 2 -->
                <div class="ad-container">
                    <div class="ad-title">Annonce</div>
                    <script type="text/javascript">
                        atOptions = {
                            'key' : 'b60bc4acc212e29cd7bb4880768c98b6',
                            'format' : 'iframe',
                            'height' : 60,
                            'width' : 468,
                            'params' : {}
                        };
                    </script>
                    <script type="text/javascript" src="//hedwigflooredventure.com/b60bc4acc212e29cd7bb4880768c98b6/invoke.js"></script>
                </div>

                <!-- Additional Ad Space -->
                <div class="ad-container">
                    <div class="ad-title">Sponsorisé</div>
                    <p>Espace disponible</p>
                    <p>Contactez-nous pour promouvoir votre entreprise</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer>
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h4>À propos de djioukeli.com</h4>
                    <p>Plateforme de partage de vidéos privées et premium.</p>
                </div>
                <div class="footer-section">
                    <h4>Liens rapides</h4>
                    <a href="index.html">Accueil</a>
                    <a href="#">Vidéos tendance</a>
                    <a href="#">Catégories</a>
                    <a href="#">À propos</a>
                </div>
                <div class="footer-section">
                    <h4>Contact</h4>
                    <a href="mailto:assistance@djoukeli.com">assistance@djoukeli.com</a>
                    <p>Pour toute question ou partenariat</p>
                </div>
            </div>
            <div class="copyright">
                <p>&copy; 2023 djioukeli.com. Tous droits réservés.</p>
            </div>
        </div>
        <!-- Bottom Navigation Bar -->
<div class="bottom-nav">
    <a href="index.html" class="nav-item active">
        <div class="nav-icon"><i class="fas fa-home"></i></div>
        <span>Accueil</span>
    </a>
    <a href="latest.html" class="nav-item">
        <div class="nav-icon"><i class="fas fa-play-circle"></i></div>
        <span>Vidéos</span>
    </a>
    <a href="photos.html" class="nav-item">
        <div class="nav-icon"><i class="fas fa-image"></i></div>
        <span>Photos</span>
    </a>
    <a href="upload.html" class="nav-item" onclick="checkAuthBeforeAction('upload.html'); return false;">
        <div class="nav-icon"><i class="fas fa-plus-circle"></i></div>
        <span>Ajouter</span>
    </a>
</div>
    </footer>

    <script>
        // Configuration Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyCTj9H9KidzwYDr8Onl_UGqxC58ZlGBMfg",
            authDomain: "test-c81f5.firebaseapp.com",
            projectId: "test-c81f5",
            storageBucket: "test-c81f5.firebasestorage.app",
            messagingSenderId: "94288484954",
            appId: "1:94288484954:web:cede6d5cf48ede3806d663",
            measurementId: "G-6WK15KWD4L"
        };
     
        // Initialiser Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        } else {
            firebase.app(); // Si déjà initialisé, utilise l'instance existante
        }

        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();
       
        // Variables globales

    // Variables globales
    let currentVideoId = null;
    let currentVideoData = null;
    let adShown = false;
    let videoWatched = false;

    // Fonction pour ouvrir le lien publicitaire DIRECTEMENT (sans modal)
    function openAdLink() {
        window.open('https://hedwigflooredventure.com/uf868bcft2?key=e8c8806d43592d84d110a00142dc05e8', '_blank');
        
        // Redémarrer la vidéo après avoir cliqué sur la pub
        const videoPlayer = document.getElementById('featuredVideoPlayer');
        if (videoPlayer) {
            videoPlayer.play();
        }
        
        // Fermer l'overlay publicitaire s'il existe
        const adOverlay = document.getElementById('adOverlay');
        if (adOverlay) {
            adOverlay.style.display = 'none';
        }
    }

    // Fonction pour afficher l'overlay publicitaire (modifiée pour intégration directe)
    function showAdOverlay() {
        // Intégration directe du lien publicitaire sans modal supplémentaire
        openAdLink();
    }

    // Fonctions pour les modals (conservées pour d'autres usages)
    function openModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.style.display = 'block';
        }
    }

    function closeModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.style.display = 'none';
        }
    }

    function showAlert(title, message) {
        const alertModalTitle = document.getElementById('alertModalTitle');
        const alertModalMessage = document.getElementById('alertModalMessage');
        
        if (alertModalTitle) alertModalTitle.textContent = title;
        if (alertModalMessage) alertModalMessage.textContent = message;
        
        openModal('alertModal');
    }

    // Fermer les modals en cliquant à l'extérieur
    window.onclick = function(event) {
        const modals = ['shareModal', 'alertModal'];
        
        modals.forEach(modalId => {
            const modal = document.getElementById(modalId);
            if (event.target === modal) {
                closeModal(modalId);
            }
        });
    };

    // Fonction pour charger la vidéo principale
    function loadVideo() {
        const urlParams = new URLSearchParams(window.location.search);
        currentVideoId = urlParams.get('id');
        
        if (!currentVideoId) {
            showError("Aucune vidéo spécifiée", "L'URL ne contient pas d'ID de vidéo.");
            return;
        }
        
        // Charger les données de la vidéo
        db.collection('videos').doc(currentVideoId).get()
        .then((doc) => {
            if (doc.exists) {
                currentVideoData = doc.data();
                currentVideoData.id = doc.id;
                
                // Mettre à jour l'interface
                displayVideo(currentVideoData);
                
                // Charger les vidéos similaires basées sur le titre
                loadSimilarVideosByTitle(currentVideoData.title);
                
                // Incrémenter le compteur de vues
                incrementVideoViews(currentVideoId);
            } else {
                showError("Vidéo non trouvée", "Cette vidéo n'existe pas ou a été supprimée.");
            }
        })
        .catch((error) => {
            showError("Erreur de chargement", "Une erreur s'est produite lors du chargement de la vidéo.");
        });
    }

    // Afficher un message d'erreur
    function showError(title, message) {
        const featuredContainer = document.getElementById('featuredVideoContainer');
        const errorContainer = document.getElementById('errorContainer');
        
        if (featuredContainer) featuredContainer.style.display = 'none';
        
        showAlert(title, message);
        
        // Charger quand même des vidéos similaires
        loadRandomVideos();
    }

    // Fonction pour ajouter des crédits à l'utilisateur
    function addCreditsToUser(userId, creditsToAdd) {
        if (!userId) return;
        
        const userRef = db.collection('users').doc(userId);
        
        db.runTransaction((transaction) => {
            return transaction.get(userRef).then((doc) => {
                if (!doc.exists) {
                    throw new Error("L'utilisateur n'existe pas");
                }
                
                const currentCredits = doc.data().credits || 0;
                const newCredits = currentCredits + creditsToAdd;
                
                transaction.update(userRef, {
                    credits: newCredits,
                    lastCreditUpdate: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                return newCredits;
            });
        }).then((newCredits) => {
            console.log(`Crédits ajoutés avec succès. Nouveau total: ${newCredits}`);
            // Mettre à jour l'affichage des crédits si l'utilisateur est connecté
            if (auth.currentUser && auth.currentUser.uid === userId) {
                updateCreditsDisplay(newCredits);
            }
        }).catch((error) => {
            console.error("Erreur lors de l'ajout des crédits:", error);
        });
    }

    // Fonction pour vérifier si l'utilisateur a déjà reçu des crédits pour cette vidéo
    function hasUserReceivedCreditsForVideo(userId, videoId) {
        const watchedVideos = JSON.parse(localStorage.getItem('watchedVideos') || '{}');
        return watchedVideos[userId] && watchedVideos[userId].includes(videoId);
    }

    // Fonction pour marquer la vidéo comme regardée (pour éviter de donner des crédits multiples)
    function markVideoAsWatched(userId, videoId) {
        const watchedVideos = JSON.parse(localStorage.getItem('watchedVideos') || '{}');
        
        if (!watchedVideos[userId]) {
            watchedVideos[userId] = [];
        }
        
        if (!watchedVideos[userId].includes(videoId)) {
            watchedVideos[userId].push(videoId);
            localStorage.setItem('watchedVideos', JSON.stringify(watchedVideos));
        }
    }

    // Fonction pour mettre à jour l'affichage des crédits
    function updateCreditsDisplay(credits) {
        const creditsElements = document.querySelectorAll('.user-credits');
        creditsElements.forEach(element => {
            element.textContent = credits;
        });
        
        // Afficher le message d'invitation à se connecter si l'utilisateur n'est pas connecté
        const user = auth.currentUser;
        const creditsContainer = document.getElementById('userCredits');
        const loginPrompt = document.getElementById('loginPrompt');
        
        if (creditsContainer && loginPrompt) {
            if (user) {
                creditsContainer.style.display = 'flex';
                loginPrompt.style.display = 'none';
            } else {
                creditsContainer.style.display = 'none';
                loginPrompt.style.display = 'block';
            }
        }
    }

    // Fonction pour initialiser l'affichage des crédits
    function initCreditsDisplay() {
        const user = auth.currentUser;
        if (user) {
            // Charger les crédits de l'utilisateur
            db.collection('users').doc(user.uid).get()
                .then((doc) => {
                    if (doc.exists) {
                        const credits = doc.data().credits || 0;
                        updateCreditsDisplay(credits);
                    }
                })
                .catch((error) => {
                    console.error("Erreur lors du chargement des crédits:", error);
                });
        } else {
            // Masquer les crédits et afficher l'invitation à se connecter
            updateCreditsDisplay(0);
        }
    }

    // Fonction pour gérer l'affichage/masquage des crédits selon l'état de connexion
    function handleCreditsDisplayOnAuthState(user) {
        const creditsContainer = document.getElementById('userCredits');
        const loginPrompt = document.getElementById('loginPrompt');
        
        if (creditsContainer && loginPrompt) {
            if (user) {
                // Afficher les crédits
                creditsContainer.style.display = 'flex';
                loginPrompt.style.display = 'none';
                // Charger les crédits de l'utilisateur
                initCreditsDisplay();
            } else {
                // Masquer les crédits et afficher l'invitation
                creditsContainer.style.display = 'none';
                loginPrompt.style.display = 'block';
            }
        }
    }

    // Afficher la vidéo dans l'interface avec désactivation du téléchargement
    function displayVideo(videoData) {
        const videoPlayer = document.getElementById('featuredVideoPlayer');
        const videoTitle = document.getElementById('featuredVideoTitle');
        const videoViews = document.getElementById('featuredVideoViews');
        const videoDate = document.getElementById('featuredVideoDate');
        const videoUsername = document.getElementById('featuredVideoUsername');
        
        if (videoPlayer) {
            videoPlayer.innerHTML = `<source src="${videoData.videoUrl}" type="video/mp4">`;
            
            // DÉSACTIVER LE TÉLÉCHARGEMENT - Empêcher le menu contextuel et le drag & drop
            videoPlayer.addEventListener('contextmenu', function(e) {
                e.preventDefault();
                return false;
            });
            
            // Empêcher le drag & drop du lecteur vidéo
            videoPlayer.addEventListener('dragstart', function(e) {
                e.preventDefault();
                return false;
            });
            
            // Gestion des erreurs de lecture vidéo
            videoPlayer.addEventListener('error', function(e) {
                showError("Erreur de lecture", "Impossible de lire la vidéo. Le fichier est peut-être corrompu ou inaccessible.");
            });
            
            // Événement pour gérer la publicité après 2 secondes
            videoPlayer.addEventListener('play', function() {
                // Si la pub n'a pas encore été affichée, planifier l'ouverture après 2 secondes
                if (!adShown) {
                    setTimeout(function() {
                        if (!videoPlayer.paused) {
                            // Afficher la publicité DIRECTEMENT sans modal
                            showAdOverlay();
                            adShown = true;
                        }
                    }, 2000);
                }
            });
            
            // Suivi de la progression de la vidéo pour attribuer les crédits
            videoPlayer.addEventListener('timeupdate', function() {
                // Donner des crédits si l'utilisateur a regardé au moins 80% de la vidéo
                if (!videoWatched && videoPlayer.duration > 0) {
                    const progress = (videoPlayer.currentTime / videoPlayer.duration) * 100;
                    
                    if (progress >= 80) {
                        videoWatched = true;
                        
                        // Vérifier si l'utilisateur est connecté
                        const user = auth.currentUser;
                        if (user) {
                            // Vérifier si l'utilisateur n'a pas déjà reçu des crédits pour cette vidéo
                            if (!hasUserReceivedCreditsForVideo(user.uid, currentVideoId)) {
                                // Ajouter 5 crédits à l'utilisateur
                                addCreditsToUser(user.uid, 5);
                                markVideoAsWatched(user.uid, currentVideoId);
                                
                                // Afficher une notification
                                showAlert("Crédits gagnés!", "Vous avez reçu 5 crédits pour avoir regardé cette vidéo.");
                            }
                        }
                    }
                }
            });
            
            videoPlayer.load();
        }
        
        if (videoTitle) {
            videoTitle.textContent = videoData.title;
        }
        
        if (videoViews) {
            videoViews.textContent = videoData.views || 0;
        }
        
        if (videoDate && videoData.timestamp) {
            videoDate.textContent = new Date(videoData.timestamp.seconds * 1000).toLocaleDateString('fr-FR');
        }
        
        if (videoUsername) {
            videoUsername.textContent = videoData.username || 'Utilisateur';
        }
        
        // Mettre à jour les métadonnées pour le partage
        updateMetaTags(videoData);
    }

    // Charger les vidéos similaires basées sur le titre
    function loadSimilarVideosByTitle(title) {
        const similarContainer = document.getElementById('similarVideosContainer');
        
        // Afficher l'indicateur de chargement
        similarContainer.innerHTML = `
            <div class="loading">
                <div class="loading-spinner"></div>
            </div>
        `;
        
        // Extraire les mots-clés du titre
        const keywords = title.split(/\s+/).filter(word => word.length > 3);
        
        if (keywords.length === 0) {
            loadRandomVideos();
            return;
        }
        
        // Charger toutes les vidéos et filtrer côté client par similarité de titre
        db.collection('videos')
            .get()
        .then((querySnapshot) => {
            if (querySnapshot.empty) {
                loadRandomVideos();
                return;
            }
            
            const allVideos = [];
            querySnapshot.forEach((doc) => {
                if (doc.id !== currentVideoId) {
                    const videoData = doc.data();
                    videoData.id = doc.id;
                    
                    // Calculer un score de similarité basé sur le titre
                    let similarityScore = 0;
                    for (const keyword of keywords) {
                        if (videoData.title && videoData.title.toLowerCase().includes(keyword.toLowerCase())) {
                            similarityScore += 1;
                        }
                    }
                    
                    if (similarityScore > 0) {
                        videoData.similarityScore = similarityScore;
                        allVideos.push(videoData);
                    }
                }
            });
            
            // Trier par score de similarité (puis par date si égalité)
            allVideos.sort((a, b) => {
                if (b.similarityScore !== a.similarityScore) {
                    return b.similarityScore - a.similarityScore;
                }
                return (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0);
            });
            
            // Prendre les 6 premières
            const similarVideos = allVideos.slice(0, 6);
            
            if (similarVideos.length === 0) {
                loadRandomVideos();
                return;
            }
            
            // Afficher les vidéos similaires
            displaySimilarVideos(similarVideos);
        })
        .catch((error) => {
            loadRandomVideos();
        });
    }

    // Charger des vidéos aléatoires
    function loadRandomVideos() {
        const similarContainer = document.getElementById('similarVideosContainer');
        
        // Charger toutes les vidéos et filtrer côté client
        db.collection('videos')
            .get()
        .then((querySnapshot) => {
            if (querySnapshot.empty) {
                similarContainer.innerHTML = '<p>Aucune vidéo trouvée.</p>';
                return;
            }
            
            const allVideos = [];
            querySnapshot.forEach((doc) => {
                if (doc.id !== currentVideoId) {
                    const videoData = doc.data();
                    videoData.id = doc.id;
                    allVideos.push(videoData);
                }
            });
            
            // Mélanger aléatoirement et prendre 6 vidéos
            const shuffled = allVideos.sort(() => 0.5 - Math.random());
            const randomVideos = shuffled.slice(0, 6);
            
            if (randomVideos.length === 0) {
                similarContainer.innerHTML = '<p>Aucune vidéo similaire trouvée.</p>';
                return;
            }
            
            // Afficher les vidéos
            displaySimilarVideos(randomVideos);
        })
        .catch((error) => {
            similarContainer.innerHTML = '<p>Aucune vidéo similaire trouvée.</p>';
        });
    }

    // Afficher les vidéos similaires avec ratio 3:2
    function displaySimilarVideos(videosArray) {
        const similarContainer = document.getElementById('similarVideosContainer');
        
        if (!videosArray || videosArray.length === 0) {
            similarContainer.innerHTML = '<p>Aucune vidéo similaire trouvée.</p>';
            return;
        }
        
        similarContainer.innerHTML = '';
        
        videosArray.forEach((videoData) => {
            const videoCard = document.createElement('div');
            videoCard.className = 'video-card';
            videoCard.onclick = function() {
                window.location.href = 'video.html?id=' + videoData.id;
            };
            
            // Formater la date de publication
            const publishDate = videoData.timestamp ? 
                new Date(videoData.timestamp.seconds * 1000).toLocaleDateString('fr-FR') : 
                'Date inconnue';
            
            videoCard.innerHTML = `
                <div class="video-thumbnail" style="position: relative; width: 100%; padding-top: 66.66%; /* Ratio 3:2 */ overflow: hidden;">
                    <video style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover;">
                        <source src="${videoData.videoUrl}" type="video/mp4">
                    </video>
                </div>
                <div class="video-info">
                    <h3 class="video-title">${videoData.title}</h3>
                    <div class="video-meta">
                        <span><i class="fas fa-eye"></i> ${videoData.views || 0}</span>
                        <span>${publishDate}</span>
                    </div>
                </div>
            `;
            
            // Désactiver le téléchargement pour les vignettes aussi
            const thumbnailVideo = videoCard.querySelector('video');
            if (thumbnailVideo) {
                thumbnailVideo.addEventListener('contextmenu', function(e) {
                    e.preventDefault();
                    return false;
                });
                
                thumbnailVideo.addEventListener('dragstart', function(e) {
                    e.preventDefault();
                    return false;
                });
            }
            
            similarContainer.appendChild(videoCard);
        });
    }

    // Incrémenter le compteur de vues
    function incrementVideoViews(videoId) {
        const viewedVideos = JSON.parse(sessionStorage.getItem('viewedVideos') || '[]');
        
        if (!viewedVideos.includes(videoId)) {
            const videoRef = db.collection('videos').doc(videoId);
            videoRef.update({
                views: firebase.firestore.FieldValue.increment(1)
            });
            
            viewedVideos.push(videoId);
            sessionStorage.setItem('viewedVideos', JSON.stringify(viewedVideos));
        }
    }

    // Fonctions de partage
    function shareVideo(videoId, platform) {
        const shareUrl = window.location.href;
        const title = "Regardez cette vidéo sur djioukeli.com!";
        
        if (platform === 'facebook') {
            window.open(`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(shareUrl)}`, '_blank');
        } else if (platform === 'twitter') {
            window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(title)}&url=${encodeURIComponent(shareUrl)}`, '_blank');
        } else if (platform === 'whatsapp') {
            window.open(`https://wa.me/?text=${encodeURIComponent(title + ' ' + shareUrl)}`, '_blank');
        }
        
        closeModal('shareModal');
    }

    function copyShareLink(videoId) {
        const shareUrl = window.location.href;
        
        navigator.clipboard.writeText(shareUrl).then(() => {
            showAlert("Succès", "Lien copié dans le presse-papier!");
        }).catch(err => {
            const textArea = document.createElement("textarea");
            textArea.value = shareUrl;
            document.body.appendChild(textArea);
            textArea.select();
            try {
                document.execCommand('copy');
                showAlert("Succès", "Lien copié dans le presse-papier!");
            } catch (err) {
                showAlert("Erreur", "Impossible de copier le lien");
            }
            document.body.removeChild(textArea);
        });
        
        closeModal('shareModal');
    }

    // Fonction pour mettre à jour les métadonnées OG
    function updateMetaTags(videoData) {
        const metaTags = [
            { property: 'og:title', content: videoData.title + ' - djioukeli.com' },
            { property: 'og:description', content: videoData.description ? videoData.description.substring(0, 300) : 'Regardez cette vidéo sur djioukeli.com' },
            { property: 'og:image', content: videoData.thumbnailUrl || 'https://raw.githubusercontent.com/pinenikeuse/mougouli/main/1747616058238.jpg' },
            { property: 'og:url', content: window.location.href },
            { property: 'og:type', content: 'video.movie' },
            { property: 'og:video', content: videoData.videoUrl },
            { property: 'og:video:type', content: 'video/mp4' },
            { property: 'og:video:width', content: '1280' },
            { property: 'og:video:height', content: '720' },
            { name: 'twitter:card', content: 'player' },
            { name: 'twitter:site', content: '@djioukeli' },
            { name: 'twitter:title', content: videoData.title },
            { name: 'twitter:description', content: videoData.description ? videoData.description.substring(0, 200) : 'Regardez cette vidéo sur djioukeli.com' },
            { name: 'twitter:image', content: videoData.thumbnailUrl || 'https://raw.githubusercontent.com/pinenikeuse/mougouli/main/1747616058238.jpg' },
            { name: 'twitter:player', content: window.location.origin + '/embed.html?video=' + videoData.id },
            { name: 'twitter:player:width', content: '1280' },
            { name: 'twitter:player:height', content: '720' }
        ];

        metaTags.forEach(tag => {
            let selector;
            if (tag.property) {
                selector = `meta[property="${tag.property}"]`;
            } else if (tag.name) {
                selector = `meta[name="${tag.name}"]`;
            }

            let metaTag = document.querySelector(selector);
            
            if (!metaTag) {
                metaTag = document.createElement('meta');
                if (tag.property) {
                    metaTag.setAttribute('property', tag.property);
                } else if (tag.name) {
                    metaTag.setAttribute('name', tag.name);
                }
                document.head.appendChild(metaTag);
            }
            
            metaTag.setAttribute('content', tag.content);
        });
        
        // Mettre à jour le titre de la page
        document.title = videoData.title + ' - djioukeli.com';
    }

    // Fonction pour vérifier l'authentification avant certaines actions
    function checkAuthBeforeAction(page) {
        const user = auth.currentUser;
        if (!user && (page === 'upload.html' || page === 'publier.html' || page === 'myprofile.html')) {
            openAuthModal();
            return false;
        }
        navigateTo(page);
        return true;
    }

    // Fonction de navigation fluide
    function navigateTo(page) {
        // Animation de transition
        document.body.style.opacity = "0.8";
        document.body.style.transition = "opacity 0.3s ease";
        
        setTimeout(() => {
            window.location.href = page;
        }, 300);
    }

    // Gestion de la navigation active au chargement de la page
    function setActiveNavItem() {
        const currentPage = window.location.pathname.split('/').pop() || 'index.html';
        const navItems = document.querySelectorAll('.nav-item');
        
        navItems.forEach(item => {
            const href = item.getAttribute('href');
            if (href === currentPage) {
                item.classList.add('active');
            } else {
                item.classList.remove('active');
            }
        });
    }

    // Initialiser au chargement de la page
    window.addEventListener('load', function() {
        setActiveNavItem();
        loadVideo();
        initCreditsDisplay(); // Initialiser l'affichage des crédits
        
        // Ajouter également les autres écouteurs d'événements nécessaires
        document.querySelectorAll('.nav-item').forEach(item => {
            if (item.getAttribute('href') === 'upload.html') {
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    checkAuthBeforeAction('upload.html');
                });
            }
        });
    });

    // Ajouter cette ligne pour gérer l'affichage des crédits lors des changements d'état d'authentification
    auth.onAuthStateChanged(handleCreditsDisplayOnAuthState);
</script>
</body>
</html>
