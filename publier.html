<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Publier une vidéo - Djoukeli.com</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #4a6bff;
            --secondary-color: #ff6b4a;
            --dark-color: #333;
            --light-color: #f5f5f5;
            --success-color: #28a745;
            --error-color: #dc3545;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f0f2f5;
            color: var(--dark-color);
            line-height: 1.6;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 1px solid #ddd;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            text-decoration: none;
            color: var(--dark-color);
            transition: color 0.3s;
        }
        
        .logo:hover {
            color: var(--primary-color);
        }
        
        .logo h1 {
            font-size: 24px;
            color: var(--primary-color);
        }
        
        .header-buttons {
            display: flex;
            gap: 15px;
        }
        
        .upload-container {
            background-color: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
        }
        
        .form-control {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        
        textarea.form-control {
            min-height: 100px;
            resize: vertical;
        }
        
        .upload-area {
            border: 2px dashed #ccc;
            border-radius: 8px;
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 20px;
        }
        
        .upload-area:hover {
            border-color: var(--primary-color);
            background-color: rgba(74, 107, 255, 0.05);
        }
        
        .upload-area i {
            font-size: 48px;
            color: #aaa;
            margin-bottom: 15px;
            display: block;
        }
        
        .upload-area p {
            color: #777;
            margin-bottom: 15px;
        }
        
        .btn {
            display: inline-block;
            padding: 12px 24px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            text-decoration: none;
        }
        
        .btn:hover {
            background-color: #3a5be0;
            transform: translateY(-2px);
        }
        
        .btn-secondary {
            background-color: #6c757d;
        }
        
        .btn-secondary:hover {
            background-color: #5a6268;
        }
        
        .btn-success {
            background-color: var(--success-color);
        }
        
        .btn-success:hover {
            background-color: #218838;
        }
        
        .btn-outline {
            background-color: transparent;
            border: 2px solid var(--primary-color);
            color: var(--primary-color);
        }
        
        .btn-outline:hover {
            background-color: var(--primary-color);
            color: white;
        }
        
        .preview-container {
            margin-top: 30px;
            display: none;
        }
        
        .preview-title {
            margin-bottom: 15px;
            font-weight: 600;
            color: var(--dark-color);
        }
        
        .video-preview {
            width: 100%;
            border-radius: 8px;
            margin-bottom: 20px;
            background-color: #000;
            max-height: 400px;
        }
        
        .thumbnail-option {
            text-align: center;
            margin-bottom: 20px;
        }
        
        .thumbnail-preview {
            width: 100%;
            max-width: 300px;
            height: 180px;
            object-fit: cover;
            border-radius: 5px;
            margin-bottom: 10px;
            border: 2px solid transparent;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .thumbnail-preview:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .thumbnail-preview.selected {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(74, 107, 255, 0.3);
        }
        
        .progress-container {
            margin-top: 20px;
            display: none;
        }
        
        .progress-bar {
            height: 10px;
            background-color: #e9ecef;
            border-radius: 5px;
            overflow: hidden;
        }
        
        .progress {
            height: 100%;
            background-color: var(--primary-color);
            width: 0%;
            transition: width 0.3s;
        }
        
        .status {
            margin-top: 15px;
            padding: 10px;
            border-radius: 5px;
            display: none;
        }
        
        .status.success {
            background-color: rgba(40, 167, 69, 0.2);
            color: var(--success-color);
            display: block;
        }
        
        .status.error {
            background-color: rgba(220, 53, 69, 0.2);
            color: var(--error-color);
            display: block;
        }
        
        .navigation {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }
        
        /* Modal de confirmation */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            text-align: center;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.2);
        }
        
        .modal-icon {
            font-size: 60px;
            color: var(--success-color);
            margin-bottom: 20px;
        }
        
        .modal h2 {
            margin-bottom: 15px;
            color: var(--dark-color);
        }
        
        .modal p {
            margin-bottom: 25px;
            color: #666;
        }
        
        @media (max-width: 768px) {
            header {
                flex-direction: column;
                text-align: center;
                gap: 15px;
            }
            
            .header-buttons {
                width: 100%;
                justify-content: center;
            }
            
            .navigation {
                flex-direction: column;
                gap: 10px;
            }
            
            .navigation .btn {
                width: 100%;
            }
        }
    </style>
    <!-- Inclure Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
</head>
<body>
    <div class="container">
        <header>
            <a href="index.html" class="logo">
                <i class="fas fa-play-circle fa-2x"></i>
                <h1>Djoukeli.com</h1>
            </a>
            <div class="header-buttons">
                <a href="index.html" class="btn btn-outline"><i class="fas fa-home"></i> Accueil</a>
            </div>
        </header>
        
        <div class="upload-container">
            <h2 style="margin-bottom: 20px; text-align: center;">Publier une vidéo</h2>
            
            <div class="form-group">
                <label for="videoTitle">Titre de la vidéo</label>
                <input type="text" id="videoTitle" class="form-control" placeholder="Donnez un titre attractif à votre vidéo">
            </div>
            
            <div class="form-group">
                <label for="videoDescription">Description</label>
                <textarea id="videoDescription" class="form-control" placeholder="Décrivez le contenu de votre vidéo"></textarea>
            </div>
            
            <div class="form-group">
                <label>Télécharger votre vidéo</label>
                <div class="upload-area" id="videoUploadArea">
                    <i class="fas fa-file-video"></i>
                    <p>Glissez-déposez votre vidéo ici ou cliquez pour parcourir</p>
                    <button class="btn"><i class="fas fa-upload"></i> Sélectionner une vidéo</button>
                    <input type="file" id="videoFile" accept="video/*" style="display: none;">
                </div>
            </div>
            
            <div class="preview-container" id="previewContainer">
                <h3 class="preview-title">Aperçu de la vidéo</h3>
                <video class="video-preview" id="videoPreview" controls></video>
                
                <h3 class="preview-title">Miniature</h3>
                <div class="thumbnail-option">
                    <img id="singleThumbnail" class="thumbnail-preview" src="https://via.placeholder.com/300x180/4a6bff/ffffff?text=Miniature+par+défaut">
                    <p id="thumbnailLabel">Miniature par défaut (générée automatiquement)</p>
                </div>
            </div>
            
            <div class="form-group">
                <label>Changer la miniature (optionnel)</label>
                <div class="upload-area" id="thumbnailUploadArea">
                    <i class="fas fa-image"></i>
                    <p>Glissez-déposez votre miniature ici ou cliquez pour parcourir</p>
                    <button class="btn btn-secondary"><i class="fas fa-upload"></i> Changer la miniature</button>
                    <input type="file" id="thumbnailFile" accept="image/*" style="display: none;">
                </div>
            </div>
            
            <div class="progress-container" id="progressContainer">
                <p>Téléchargement en cours...</p>
                <div class="progress-bar">
                    <div class="progress" id="uploadProgress"></div>
                </div>
                <p id="progressPercentage">0%</p>
            </div>
            
            <div class="status" id="uploadStatus"></div>
            
            <div class="navigation">
                <a href="index.html" class="btn btn-outline"><i class="fas fa-arrow-left"></i> Retour à l'accueil</a>
                <button class="btn btn-success" id="publishBtn" disabled><i class="fas fa-cloud-upload-alt"></i> Publier la vidéo</button>
            </div>
        </div>
    </div>

    <!-- Modal de confirmation -->
    <div class="modal" id="confirmationModal">
        <div class="modal-content">
            <div class="modal-icon">
                <i class="fas fa-check-circle"></i>
            </div>
            <h2>Vidéo publiée avec succès!</h2>
            <p>Votre vidéo a été téléchargée et publiée sur Djoukeli.com.</p>
            <button class="btn" id="modalCloseBtn">Fermer</button>
        </div>
    </div>

    <script>
        // Configuration Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyCTj9H9KidzwYDr8Onl_UGqxC58ZlGBMfg",
            authDomain: "test-c81f5.firebaseapp.com",
            projectId: "test-c81f5",
            storageBucket: "test-c81f5.firebasestorage.app",
            messagingSenderId: "94288484954",
            appId: "1:94288484954:web:cede6d5cf48ede3806d663",
            measurementId: "G-6WK15KWD4L"
        };
     
        // Initialiser Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        } else {
            firebase.app(); // Si déjà initialisé, utilise l'instance existante
        }

        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();
       
        // Variables globales
        let currentUser = null;
        let videoFile = null;
        let thumbnailFile = null;
        let generatedThumbnailBlob = null;

        // Initialisation de la page
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Page de téléchargement initialisée');
            
            // Vérifier l'état d'authentification
            auth.onAuthStateChanged(user => {
                if (user) {
                    currentUser = user;
                    console.log('Utilisateur connecté:', user.uid);
                } else {
                    // Se connecter anonymement pour résoudre les problèmes d'autorisation
                    auth.signInAnonymously()
                        .then(userCredential => {
                            currentUser = userCredential.user;
                            console.log('Utilisateur connecté anonymement:', currentUser.uid);
                        })
                        .catch(error => {
                            console.error('Erreur de connexion anonyme:', error);
                            showStatus('Erreur d\'authentification. Veuillez rafraîchir la page.', 'error');
                        });
                }
            });
            
            // Écouteurs d'événements pour le téléchargement de vidéo
            const videoUploadArea = document.getElementById('videoUploadArea');
            const videoFileInput = document.getElementById('videoFile');
            
            videoUploadArea.addEventListener('click', () => {
                videoFileInput.click();
            });
            
            videoFileInput.addEventListener('change', handleVideoSelection);
            
            // Écouteurs d'événements pour le téléchargement de miniature
            const thumbnailUploadArea = document.getElementById('thumbnailUploadArea');
            const thumbnailFileInput = document.getElementById('thumbnailFile');
            
            thumbnailUploadArea.addEventListener('click', () => {
                thumbnailFileInput.click();
            });
            
            thumbnailFileInput.addEventListener('change', handleThumbnailSelection);
            
            // Événement de publication
            document.getElementById('publishBtn').addEventListener('click', publishVideo);
            
            // Fermer le modal
            document.getElementById('modalCloseBtn').addEventListener('click', () => {
                document.getElementById('confirmationModal').style.display = 'none';
            });
            
            // Gestion du glisser-déposer
            setupDragAndDrop();
        });

        // Gestion de la sélection de vidéo
        function handleVideoSelection(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            if (!file.type.startsWith('video/')) {
                showStatus('Veuillez sélectionner un fichier vidéo valide', 'error');
                return;
            }
            
            videoFile = file;
            console.log(`Vidéo sélectionnée: ${file.name}`);
            
            // Afficher l'aperçu de la vidéo
            const videoPreview = document.getElementById('videoPreview');
            videoPreview.src = URL.createObjectURL(file);
            
            // Afficher le conteneur d'aperçu
            document.getElementById('previewContainer').style.display = 'block';
            
            // Générer une miniature automatique
            generateThumbnail(videoPreview);
            
            // Activer le bouton de publication
            document.getElementById('publishBtn').disabled = false;
            
            // Faire défiler vers le bas pour montrer l'aperçu
            setTimeout(() => {
                document.getElementById('previewContainer').scrollIntoView({ behavior: 'smooth' });
            }, 500);
        }

        // Gestion de la sélection de miniature
        function handleThumbnailSelection(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            if (!file.type.startsWith('image/')) {
                showStatus('Veuillez sélectionner un fichier image valide', 'error');
                return;
            }
            
            thumbnailFile = file;
            console.log(`Miniature sélectionnée: ${file.name}`);
            
            // Afficher la miniature personnalisée
            const thumbnailImg = document.getElementById('singleThumbnail');
            thumbnailImg.src = URL.createObjectURL(file);
            document.getElementById('thumbnailLabel').textContent = 'Votre miniature personnalisée';
            
            // Faire défiler vers le bas pour montrer la miniature
            setTimeout(() => {
                thumbnailImg.scrollIntoView({ behavior: 'smooth' });
            }, 500);
        }

        // Configuration du glisser-déposer
        function setupDragAndDrop() {
            const videoArea = document.getElementById('videoUploadArea');
            const thumbnailArea = document.getElementById('thumbnailUploadArea');
            
            // Pour la vidéo
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                videoArea.addEventListener(eventName, preventDefaults, false);
            });
            
            videoArea.addEventListener('drop', handleVideoDrop, false);
            
            // Pour la miniature
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                thumbnailArea.addEventListener(eventName, preventDefaults, false);
            });
            
            thumbnailArea.addEventListener('drop', handleThumbnailDrop, false);
        }
        
        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }
        
        function handleVideoDrop(e) {
            const dt = e.dataTransfer;
            const file = dt.files[0];
            
            if (file && file.type.startsWith('video/')) {
                // Simuler la sélection de fichier
                const input = document.getElementById('videoFile');
                input.files = dt.files;
                handleVideoSelection({target: input});
            }
        }
        
        function handleThumbnailDrop(e) {
            const dt = e.dataTransfer;
            const file = dt.files[0];
            
            if (file && file.type.startsWith('image/')) {
                // Simuler la sélection de fichier
                const input = document.getElementById('thumbnailFile');
                input.files = dt.files;
                handleThumbnailSelection({target: input});
            }
        }

        // Génération d'une miniature à partir de la vidéo
        function generateThumbnail(videoElement) {
            // Attendre que la vidéo soit chargée
            videoElement.addEventListener('loadeddata', function() {
                // Aller au milieu de la vidéo pour la miniature
                videoElement.currentTime = videoElement.duration * 0.5;
                
                // Capturer la frame après que la position ait été changée
                setTimeout(() => {
                    const canvas = document.createElement('canvas');
                    canvas.width = videoElement.videoWidth;
                    canvas.height = videoElement.videoHeight;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(videoElement, 0, 0, canvas.width, canvas.height);
                    
                    canvas.toBlob(blob => {
                        const thumbnailUrl = URL.createObjectURL(blob);
                        generatedThumbnailBlob = blob;
                        
                        // Afficher la miniature générée
                        const thumbnailImg = document.getElementById('singleThumbnail');
                        thumbnailImg.src = thumbnailUrl;
                    });
                }, 200);
            });
        }

        // Publication de la vidéo
        async function publishVideo() {
            const title = document.getElementById('videoTitle').value.trim();
            const description = document.getElementById('videoDescription').value.trim();
            
            if (!title) {
                showStatus('Veuillez donner un titre à votre vidéo', 'error');
                return;
            }
            
            if (!videoFile) {
                showStatus('Veuillez sélectionner une vidéo à publier', 'error');
                return;
            }
            
            // Vérifier que l'utilisateur est authentifié
            if (!currentUser) {
                showStatus('Erreur d\'authentification. Veuillez rafraîchir la page.', 'error');
                return;
            }
            
            // Désactiver le bouton de publication
            document.getElementById('publishBtn').disabled = true;
            
            // Afficher la barre de progression
            const progressContainer = document.getElementById('progressContainer');
            const progressBar = document.getElementById('uploadProgress');
            const progressPercentage = document.getElementById('progressPercentage');
            progressContainer.style.display = 'block';
            
            try {
                // Générer un ID unique pour la vidéo avec un nom de fichier unique
                const timestamp = Date.now();
                const randomId = Math.floor(Math.random() * 1000000);
                const videoId = `${timestamp}_${randomId}`;
                const uniqueVideoName = `video_${timestamp}_${randomId}.${videoFile.name.split('.').pop()}`;
                
                // Références de stockage
                const videoRef = storage.ref().child(`videos/${videoId}/${uniqueVideoName}`);
                let thumbnailRef = null;
                
                // Télécharger la vidéo
                console.log('Début du téléchargement de la vidéo');
                const uploadTask = videoRef.put(videoFile);
                
                // Surveiller la progression
                uploadTask.on('state_changed', 
                    (snapshot) => {
                        const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                        progressBar.style.width = progress + '%';
                        progressPercentage.textContent = Math.round(progress) + '%';
                        console.log(`Progression: ${Math.round(progress)}%`);
                    },
                    (error) => {
                        console.error('Erreur de téléchargement:', error);
                        
                        // Vérifier les problèmes d'autorisation spécifiques
                        if (error.code === 'storage/unauthorized') {
                            showStatus('Erreur d\'autorisation. Veuillez vérifier les règles de sécurité Firebase Storage.', 'error');
                        } else {
                            showStatus('Erreur lors du téléchargement: ' + error.message, 'error');
                        }
                        
                        document.getElementById('publishBtn').disabled = false;
                    },
                    async () => {
                        // Téléchargement terminé
                        console.log('Téléchargement vidéo terminé');
                        
                        // Obtenir l'URL de la vidéo
                        const videoUrl = await uploadTask.snapshot.ref.getDownloadURL();
                        console.log(`URL de la vidéo: ${videoUrl}`);
                        
                        let thumbnailUrl = '';
                        
                        // Traitement de la miniature
                        if (thumbnailFile) {
                            // Utiliser la miniature personnalisée
                            const thumbnailExt = thumbnailFile.name.split('.').pop();
                            thumbnailRef = storage.ref().child(`thumbnails/${videoId}/thumbnail.${thumbnailExt}`);
                            
                            console.log('Début du téléchargement de la miniature personnalisée');
                            await thumbnailRef.put(thumbnailFile);
                            thumbnailUrl = await thumbnailRef.getDownloadURL();
                            console.log(`URL de la miniature personnalisée: ${thumbnailUrl}`);
                        } else if (generatedThumbnailBlob) {
                            // Utiliser la miniature générée automatiquement
                            thumbnailRef = storage.ref().child(`thumbnails/${videoId}/thumbnail.png`);
                            
                            console.log('Début du téléchargement de la miniature générée');
                            await thumbnailRef.put(generatedThumbnailBlob);
                            thumbnailUrl = await thumbnailRef.getDownloadURL();
                            console.log(`URL de la miniature générée: ${thumbnailUrl}`);
                        } else {
                            // Utiliser une image par défaut
                            thumbnailUrl = 'https://via.placeholder.com/300x180/4a6bff/ffffff?text=Djoukeli.com';
                            console.log('Utilisation de la miniature par défaut');
                        }
                        
                        // Enregistrer les métadonnées dans Firestore
                        const videoData = {
                            title: title,
                            description: description,
                            videoUrl: videoUrl,
                            thumbnailUrl: thumbnailUrl,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                            userId: currentUser.uid,
                            views: 0,
                            likes: 0
                        };
                        
                        await db.collection('videos').doc(videoId).set(videoData);
                        console.log('Vidéo enregistrée dans la base de données');
                        
                        // Afficher le modal de confirmation
                        document.getElementById('confirmationModal').style.display = 'flex';
                        
                        // Réinitialiser le formulaire après un délai
                        setTimeout(() => {
                            resetForm();
                        }, 3000);
                    }
                );
                
            } catch (error) {
                console.error('Erreur:', error);
                showStatus('Une erreur s\'est produite: ' + error.message, 'error');
                document.getElementById('publishBtn').disabled = false;
            }
        }
        
        // Afficher un message de statut
        function showStatus(message, type) {
            const statusElement = document.getElementById('uploadStatus');
            statusElement.textContent = message;
            statusElement.className = 'status ' + type;
        }
        
        // Réinitialiser le formulaire
        function resetForm() {
            document.getElementById('videoTitle').value = '';
            document.getElementById('videoDescription').value = '';
            document.getElementById('videoFile').value = '';
            document.getElementById('thumbnailFile').value = '';
            document.getElementById('videoPreview').src = '';
            document.getElementById('previewContainer').style.display = 'none';
            document.getElementById('progressContainer').style.display = 'none';
            document.getElementById('uploadProgress').style.width = '0%';
            document.getElementById('progressPercentage').textContent = '0%';
            document.getElementById('uploadStatus').className = 'status';
            document.getElementById('publishBtn').disabled = true;
            
            // Réinitialiser la miniature
            document.getElementById('singleThumbnail').src = 'https://via.placeholder.com/300x180/4a6bff/ffffff?text=Miniature+par+défaut';
            document.getElementById('thumbnailLabel').textContent = 'Miniature par défaut (générée automatiquement)';
            
            videoFile = null;
            thumbnailFile = null;
            generatedThumbnailBlob = null;
            
            console.log('Formulaire réinitialisé');
            
            // Faire défiler vers le haut
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
    </script>
</body>
</html>
            
            console.log('Formulaire réinitialisé');
            
            // Faire défiler vers le haut
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
    </script>
</body>
</html>
